<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meow 博客管理</title>
    <link rel="stylesheet" href="/admin/common.css" />
    <style>
      .wrap {
        max-width: 980px;
      }
      textarea, input {
        width: 100%;
        box-sizing: border-box;
        border-radius: 12px;
        border: 1px solid #eadbea;
        padding: 10px 12px;
        font-size: 13px;
        background: rgba(255, 255, 255, 0.8);
      }
      textarea {
        min-height: 88px;
        resize: vertical;
      }
      .list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .item {
        border-radius: 16px;
        border: 1px solid rgba(234, 219, 234, 0.9);
        background: rgba(255, 255, 255, 0.7);
        padding: 12px;
      }
      .item-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 8px;
        font-size: 12px;
        color: #7b6b7a;
      }
      .item-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 10px;
      }
      .item-note {
        margin-top: 10px;
      }
      .hint {
        margin-top: 8px;
      }
      .danger {
        background: #a03555;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="window">
        <div class="titlebar">
          <span class="dot"></span>
          Meow Blog Admin
        </div>
        <div class="content">
          <div class="row">
            <div>
              <label>Token</label>
              <input id="token" type="password" placeholder="输入 STATUS_TOKEN" />
            </div>
            <div>
              <label>接口地址</label>
              <input id="api" type="text" value="/blog" />
            </div>
          </div>
          <div class="toolbar">
            <button id="add">新增文章</button>
            <button id="load" class="ghost">加载</button>
            <button id="save">保存</button>
          </div>
          <div class="list" id="list"></div>
          <div class="hint">提示：标题/日期必填。标签可用逗号分隔（如：碎碎念,开发,偶然）；正文每行一段，图片可用 ![说明](图片URL) 或直接填图片 URL。</div>
          <div class="status" id="status"></div>
        </div>
      </div>
    </div>
    <script>
      const statusEl = document.getElementById("status");
      const tokenEl = document.getElementById("token");
      const apiEl = document.getElementById("api");
      const listEl = document.getElementById("list");

      const setStatus = (text) => { statusEl.textContent = text; };
      const esc = (value = "") => value
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll("\"", "&quot;");

      const createItem = (item = {}) => {
        const wrap = document.createElement("div");
        wrap.className = "item";
        wrap.innerHTML = `
          <div class="item-header">
            <span>博客文章</span>
            <button class="danger" data-remove>删除</button>
          </div>
          <div class="item-grid">
            <div>
              <label>Slug</label>
              <input data-slug placeholder="如：my-first-post" value="${esc(item.slug || "")}" />
            </div>
            <div>
              <label>标题 *</label>
              <input data-title placeholder="如：博客开张" value="${esc(item.title || "")}" />
            </div>
            <div>
              <label>日期 *</label>
              <input data-date placeholder="如：2026-02-16" value="${esc(item.date || "")}" />
            </div>
            <div>
              <label>标签（逗号分隔）</label>
              <input data-tag placeholder="如：碎碎念,开发,偶然" value="${esc(item.tag || "")}" />
            </div>
            <div>
              <label>排序</label>
              <input data-sort type="number" placeholder="0" value="${item.sort_order ?? ""}" />
            </div>
          </div>
          <div class="item-note">
            <label>摘要</label>
            <textarea data-excerpt placeholder="列表展示摘要">${esc(item.excerpt || "")}</textarea>
          </div>
          <div class="item-note">
            <label>正文（每行一段）</label>
            <textarea data-content placeholder="第一段&#10;![配图说明](https://example.com/pic.jpg)&#10;或直接图片链接 https://example.com/pic.jpg">${esc((item.content || []).join("\n"))}</textarea>
          </div>
        `;
        wrap.querySelector("[data-remove]").addEventListener("click", () => {
          wrap.remove();
        });
        return wrap;
      };

      const readItems = () => {
        const items = [];
        listEl.querySelectorAll(".item").forEach((el, idx) => {
          const slug = el.querySelector("[data-slug]").value.trim();
          const title = el.querySelector("[data-title]").value.trim();
          const date = el.querySelector("[data-date]").value.trim();
          if (!title || !date) return;
          const tag = el.querySelector("[data-tag]").value.trim();
          const excerpt = el.querySelector("[data-excerpt]").value.trim();
          const sortRaw = el.querySelector("[data-sort]").value.trim();
          const content = el
            .querySelector("[data-content]")
            .value
            .split("\n")
            .map((v) => v.trim())
            .filter(Boolean);
          items.push({
            slug: slug || undefined,
            title,
            date,
            tag: tag || undefined,
            excerpt: excerpt || undefined,
            content,
            sort_order: sortRaw === "" ? idx : Number(sortRaw)
          });
        });
        return items;
      };

      const loadBlog = async () => {
        try {
          setStatus("加载中...");
          const listRes = await fetch(apiEl.value);
          if (!listRes.ok) throw new Error("list failed");
          const list = await listRes.json();
          const detailTasks = list.map(async (item) => {
            try {
              const detailRes = await fetch(`${apiEl.value}/${encodeURIComponent(item.slug)}`);
              if (!detailRes.ok) throw new Error("detail failed");
              return await detailRes.json();
            } catch (err) {
              return { ...item, content: item.excerpt ? [item.excerpt] : [] };
            }
          });
          const items = await Promise.all(detailTasks);
          listEl.innerHTML = "";
          items.forEach((item) => listEl.appendChild(createItem(item)));
          if (items.length === 0) {
            listEl.appendChild(createItem());
          }
          setStatus("已加载");
        } catch (err) {
          setStatus("加载失败");
        }
      };

      const saveBlog = async () => {
        try {
          const payload = { items: readItems() };
          setStatus("保存中...");
          const res = await fetch(apiEl.value, {
            method: "POST",
            headers: {
              "content-type": "application/json",
              "x-token": tokenEl.value
            },
            body: JSON.stringify(payload)
          });
          setStatus(res.ok ? "保存成功" : "保存失败");
        } catch (err) {
          setStatus("保存失败");
        }
      };

      document.getElementById("add").addEventListener("click", () => {
        listEl.appendChild(createItem());
      });
      document.getElementById("load").addEventListener("click", loadBlog);
      document.getElementById("save").addEventListener("click", saveBlog);
      loadBlog();
    </script>
  </body>
</html>
