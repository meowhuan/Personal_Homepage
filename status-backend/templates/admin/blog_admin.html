<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meow 博客管理</title>
    <link rel="stylesheet" href="/admin/common.css" />
    <style>
      .wrap {
        max-width: 980px;
      }
      textarea, input {
        width: 100%;
        box-sizing: border-box;
        border-radius: 12px;
        border: 1px solid #eadbea;
        padding: 10px 12px;
        font-size: 13px;
        background: rgba(255, 255, 255, 0.8);
      }
      textarea {
        min-height: 88px;
        resize: vertical;
      }
      .list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .item {
        border-radius: 16px;
        border: 1px solid rgba(234, 219, 234, 0.9);
        background: rgba(255, 255, 255, 0.7);
        padding: 12px;
      }
      .item-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 8px;
        font-size: 12px;
        color: #7b6b7a;
      }
      .item-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 10px;
      }
      .item-note {
        margin-top: 10px;
      }
      .editor-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .preview {
        border-radius: 12px;
        border: 1px solid #eadbea;
        background: rgba(255, 255, 255, 0.78);
        padding: 10px 12px;
        min-height: 120px;
        font-size: 13px;
        line-height: 1.7;
      }
      .preview > * {
        margin: 0.65em 0;
      }
      .preview h1, .preview h2, .preview h3, .preview h4 {
        margin-top: 0.9em;
        margin-bottom: 0.45em;
        line-height: 1.35;
      }
      .preview h1 { font-size: 1.45em; }
      .preview h2 { font-size: 1.28em; }
      .preview h3 { font-size: 1.14em; }
      .preview ul, .preview ol {
        padding-left: 1.35em;
      }
      .preview blockquote {
        border-left: 3px solid #d28db9;
        background: rgba(245, 230, 240, 0.55);
        border-radius: 8px;
        padding: 6px 10px;
      }
      .preview pre {
        border-radius: 10px;
        padding: 8px 10px;
        background: #21162f;
        color: #efe7ff;
        overflow-x: auto;
      }
      .preview code {
        border-radius: 6px;
        padding: 1px 4px;
        background: rgba(104, 70, 95, 0.12);
      }
      .preview pre code {
        background: transparent;
        padding: 0;
      }
      .preview table {
        border-collapse: collapse;
        width: 100%;
      }
      .preview th,
      .preview td {
        border: 1px solid #e8d8e7;
        padding: 6px 8px;
        text-align: left;
      }
      .preview img {
        display: block;
        max-width: 100%;
        max-height: 360px;
        border-radius: 10px;
        border: 1px solid #eadbea;
      }
      .hint {
        margin-top: 8px;
      }
      .danger {
        background: #a03555;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="window">
        <div class="titlebar">
          <span class="dot"></span>
          Meow Blog Admin
        </div>
        <div class="content">
          <div class="row">
            <div>
              <label>Token</label>
              <input id="token" type="password" placeholder="输入 STATUS_TOKEN" />
            </div>
            <div>
              <label>接口地址</label>
              <input id="api" type="text" value="/blog" />
            </div>
          </div>
          <div class="toolbar">
            <button id="add">新增文章</button>
            <button id="load" class="ghost">加载</button>
            <button id="save">保存</button>
          </div>
          <div class="list" id="list"></div>
          <div class="hint">提示：标题/日期必填。标签可用逗号分隔（如：碎碎念,开发,偶然）；正文支持 Markdown（标题、列表、代码块、图片、链接等）。</div>
          <div class="status" id="status"></div>
        </div>
      </div>
    </div>
    <script>
      const statusEl = document.getElementById("status");
      const tokenEl = document.getElementById("token");
      const apiEl = document.getElementById("api");
      const listEl = document.getElementById("list");

      const setStatus = (text) => { statusEl.textContent = text; };
      const esc = (value = "") => value
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll("\"", "&quot;");

      const createItem = (item = {}) => {
        const wrap = document.createElement("div");
        wrap.className = "item";
        wrap.innerHTML = `
          <div class="item-header">
            <span>博客文章</span>
            <button class="danger" data-remove>删除</button>
          </div>
          <div class="item-grid">
            <div>
              <label>Slug</label>
              <input data-slug placeholder="如：my-first-post" value="${esc(item.slug || "")}" />
            </div>
            <div>
              <label>标题 *</label>
              <input data-title placeholder="如：博客开张" value="${esc(item.title || "")}" />
            </div>
            <div>
              <label>日期 *</label>
              <input data-date placeholder="如：2026-02-16" value="${esc(item.date || "")}" />
            </div>
            <div>
              <label>标签（逗号分隔）</label>
              <input data-tag placeholder="如：碎碎念,开发,偶然" value="${esc(item.tag || "")}" />
            </div>
            <div>
              <label>排序</label>
              <input data-sort type="number" placeholder="0" value="${item.sort_order ?? ""}" />
            </div>
          </div>
          <div class="item-note">
            <label>摘要</label>
            <textarea data-excerpt placeholder="列表展示摘要">${esc(item.excerpt || "")}</textarea>
          </div>
          <div class="item-note">
            <label>正文（Markdown）</label>
            <div class="editor-grid">
              <textarea data-content placeholder="# 标题&#10;&#10;正文段落...&#10;&#10;```rust&#10;fn main() {}&#10;```&#10;&#10;![配图说明](https://example.com/pic.jpg)">${esc(item.content_md || (item.content || []).join("\n"))}</textarea>
              <div class="preview" data-preview></div>
            </div>
          </div>
        `;
        const contentEl = wrap.querySelector("[data-content]");
        const previewEl = wrap.querySelector("[data-preview]");
        const renderPreview = () => {
          previewEl.innerHTML = renderMarkdown(contentEl.value);
        };
        contentEl.addEventListener("input", renderPreview);
        renderPreview();
        wrap.querySelector("[data-remove]").addEventListener("click", () => {
          wrap.remove();
        });
        return wrap;
      };

      const safeUrl = (value) => {
        const raw = String(value || "").trim();
        if (!raw) return "";
        if (raw.startsWith("/") || raw.startsWith("./") || raw.startsWith("../") || raw.startsWith("#")) {
          return raw;
        }
        try {
          const parsed = new URL(raw);
          return ["http:", "https:", "mailto:"].includes(parsed.protocol) ? raw : "";
        } catch {
          return "";
        }
      };

      const renderInlineMarkdown = (text) => {
        let html = esc(text);
        html = html.replace(/`([^`]+)`/g, (_, code) => `<code>${code}</code>`);
        html = html.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
        html = html.replace(/\*([^*]+)\*/g, "<em>$1</em>");
        html = html.replace(/~~([^~]+)~~/g, "<del>$1</del>");
        html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (_, alt, url) => {
          const safe = safeUrl(url);
          if (!safe) return "";
          return `<img src="${esc(safe)}" alt="${esc(alt || "博客图片")}" loading="lazy" decoding="async" referrerpolicy="no-referrer" />`;
        });
        html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (_, label, url) => {
          const safe = safeUrl(url);
          if (!safe) return esc(label);
          return `<a href="${esc(safe)}" target="_blank" rel="noreferrer noopener">${esc(label)}</a>`;
        });
        return html;
      };

      const renderMarkdown = (markdown) => {
        const src = String(markdown || "").replaceAll("\r\n", "\n");
        const lines = src.split("\n");
        const html = [];
        let inCode = false;
        let codeLines = [];
        let listType = "";
        let tableHead = null;
        let tableRows = [];

        const closeList = () => {
          if (!listType) return;
          html.push(listType === "ol" ? "</ol>" : "</ul>");
          listType = "";
        };
        const flushTable = () => {
          if (!tableHead) return;
          const headHtml = `<thead><tr>${tableHead.map((cell) => `<th>${renderInlineMarkdown(cell)}</th>`).join("")}</tr></thead>`;
          const bodyHtml = tableRows.length
            ? `<tbody>${tableRows.map((row) => `<tr>${row.map((cell) => `<td>${renderInlineMarkdown(cell)}</td>`).join("")}</tr>`).join("")}</tbody>`
            : "";
          html.push(`<table>${headHtml}${bodyHtml}</table>`);
          tableHead = null;
          tableRows = [];
        };

        for (let i = 0; i < lines.length; i += 1) {
          const line = String(lines[i] || "");
          const trim = line.trim();

          if (trim.startsWith("```")) {
            closeList();
            flushTable();
            if (!inCode) {
              inCode = true;
              codeLines = [];
            } else {
              html.push(`<pre><code>${esc(codeLines.join("\n"))}</code></pre>`);
              inCode = false;
            }
            continue;
          }
          if (inCode) {
            codeLines.push(line);
            continue;
          }
          if (!trim) {
            closeList();
            flushTable();
            continue;
          }

          const heading = trim.match(/^(#{1,6})\s+(.+)$/);
          if (heading) {
            closeList();
            flushTable();
            const lv = heading[1].length;
            html.push(`<h${lv}>${renderInlineMarkdown(heading[2])}</h${lv}>`);
            continue;
          }
          if (trim === "---" || trim === "***" || trim === "___") {
            closeList();
            flushTable();
            html.push("<hr />");
            continue;
          }
          const ul = trim.match(/^[-*+]\s+(.+)$/);
          if (ul) {
            flushTable();
            if (listType !== "ul") {
              closeList();
              html.push("<ul>");
              listType = "ul";
            }
            const task = ul[1].match(/^\[( |x|X)\]\s+(.+)$/);
            if (task) {
              const checked = task[1].toLowerCase() === "x";
              html.push(`<li><input type="checkbox" disabled ${checked ? "checked" : ""} /> ${renderInlineMarkdown(task[2])}</li>`);
            } else {
              html.push(`<li>${renderInlineMarkdown(ul[1])}</li>`);
            }
            continue;
          }
          const ol = trim.match(/^\d+\.\s+(.+)$/);
          if (ol) {
            flushTable();
            if (listType !== "ol") {
              closeList();
              html.push("<ol>");
              listType = "ol";
            }
            html.push(`<li>${renderInlineMarkdown(ol[1])}</li>`);
            continue;
          }
          if (trim.startsWith(">")) {
            closeList();
            flushTable();
            html.push(`<blockquote>${renderInlineMarkdown(trim.replace(/^>\s?/, ""))}</blockquote>`);
            continue;
          }

          const isTableLine = trim.includes("|");
          if (isTableLine) {
            const cells = trim
              .split("|")
              .map((v) => v.trim())
              .filter((_, idx, arr) => !(idx === 0 && arr[idx] === "") && !(idx === arr.length - 1 && arr[idx] === ""));
            const next = String(lines[i + 1] || "").trim();
            const isAlignLine = /^[:\-|\s]+$/.test(next) && next.includes("-");
            if (!tableHead && cells.length > 0 && isAlignLine) {
              closeList();
              tableHead = cells;
              i += 1;
              continue;
            }
            if (tableHead && cells.length > 0) {
              closeList();
              tableRows.push(cells);
              continue;
            }
          }

          closeList();
          flushTable();
          html.push(`<p>${renderInlineMarkdown(trim)}</p>`);
        }

        if (inCode) {
          html.push(`<pre><code>${esc(codeLines.join("\n"))}</code></pre>`);
        }
        closeList();
        flushTable();
        return html.join("");
      };

      const readItems = () => {
        const items = [];
        listEl.querySelectorAll(".item").forEach((el, idx) => {
          const slug = el.querySelector("[data-slug]").value.trim();
          const title = el.querySelector("[data-title]").value.trim();
          const date = el.querySelector("[data-date]").value.trim();
          if (!title || !date) return;
          const tag = el.querySelector("[data-tag]").value.trim();
          const excerpt = el.querySelector("[data-excerpt]").value.trim();
          const sortRaw = el.querySelector("[data-sort]").value.trim();
          const rawContent = el.querySelector("[data-content]").value.replaceAll("\r\n", "\n");
          const content = rawContent.split("\n");
          items.push({
            slug: slug || undefined,
            title,
            date,
            tag: tag || undefined,
            excerpt: excerpt || undefined,
            content,
            content_md: rawContent,
            sort_order: sortRaw === "" ? idx : Number(sortRaw)
          });
        });
        return items;
      };

      const loadBlog = async () => {
        try {
          setStatus("加载中...");
          const listRes = await fetch(apiEl.value);
          if (!listRes.ok) throw new Error("list failed");
          const list = await listRes.json();
          const detailTasks = list.map(async (item) => {
            try {
              const detailRes = await fetch(`${apiEl.value}/${encodeURIComponent(item.slug)}`);
              if (!detailRes.ok) throw new Error("detail failed");
              return await detailRes.json();
            } catch (err) {
              return { ...item, content: item.excerpt ? [item.excerpt] : [] };
            }
          });
          const items = await Promise.all(detailTasks);
          listEl.innerHTML = "";
          items.forEach((item) => listEl.appendChild(createItem(item)));
          if (items.length === 0) {
            listEl.appendChild(createItem());
          }
          setStatus("已加载");
        } catch (err) {
          setStatus("加载失败");
        }
      };

      const saveBlog = async () => {
        try {
          const payload = { items: readItems() };
          setStatus("保存中...");
          const res = await fetch(apiEl.value, {
            method: "POST",
            headers: {
              "content-type": "application/json",
              "x-token": tokenEl.value
            },
            body: JSON.stringify(payload)
          });
          setStatus(res.ok ? "保存成功" : "保存失败");
        } catch (err) {
          setStatus("保存失败");
        }
      };

      document.getElementById("add").addEventListener("click", () => {
        listEl.appendChild(createItem());
      });
      document.getElementById("load").addEventListener("click", loadBlog);
      document.getElementById("save").addEventListener("click", saveBlog);
      loadBlog();
    </script>
  </body>
</html>
